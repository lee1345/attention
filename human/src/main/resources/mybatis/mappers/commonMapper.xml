<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fs.four.human.common.dao.CommonDAO">
    <select id="getEmployeeById" resultType="CommonVO">
        SELECT
        e_id,
        e_name,
        e_pwd,
        e_phone,
        e_email,
        e_position,
        e_dept,
        e_created_date,
        e_updated_date
        FROM employee
        WHERE e_id = #{e_id}
    </select>

    <update id="updateEmployee" parameterType="CommonVO">
        UPDATE employee
        SET
        e_phone = #{e_phone},
        e_email = #{e_email},
        e_pwd = #{e_pwd},
        e_updated_date = SYSDATE
        WHERE e_id = #{e_id}
    </update>

    <!-- 현재 시간 기준으로 발생해야 할 알림 조회 -->
    <select id="getPendingAlarms" resultType="AlarmVO">
        SELECT
        t.t_id AS alId,
        TO_CHAR(t.t_start_date - (30 / (24 * 60)), 'YYYY-MM-DD HH24:MI:SS') AS alTime,
        '30MIN' AS alCycle,
        t.t_title AS tTitle
        FROM todo t
        WHERE t.t_created_id = #{userId}
        AND t.t_start_date BETWEEN SYSDATE - (30 / (24 * 60)) AND SYSDATE
        UNION ALL
        SELECT
        t.t_id AS alId,
        TO_CHAR(t.t_start_date, 'YYYY-MM-DD HH24:MI:SS') AS alTime,
        'ONTIME' AS alCycle,
        t.t_title AS tTitle
        FROM todo t
        WHERE t.t_created_id = #{userId}
        AND t.t_start_date BETWEEN SYSDATE AND SYSDATE + (30 / (24 * 60));
    </select>

    <!-- 알림 기록 저장 -->
    <insert id="insertAlarmHistory">
        INSERT INTO alarm_history (al_id, al_time, al_cycle, t_id, al_employee)
        VALUES (#{alId}, #{alTime}, #{alCycle}, #{alId}, #{alEmployee})
    </insert>

    <!-- 알림 기록 조회 -->
    <select id="getAlarmHistory" resultType="AlarmVO">
        SELECT al_id AS alId,
        TO_CHAR(al_time, 'YYYY-MM-DD HH24:MI:SS') AS alTime,
        al_cycle AS alCycle,
        t_title AS tTitle
        FROM alarm_history
        WHERE al_employee = #{userId}
        AND TRUNC(al_time) = TRUNC(SYSDATE)
        ORDER BY al_time DESC
    </select>

    <!-- 알림 기록 삭제 -->
    <delete id="deleteAlarmHistory">
        DELETE FROM alarm_history
        WHERE al_id = #{alarmId}
    </delete>


</mapper>
